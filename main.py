import os
import asyncio
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters
)

# ================== CONFIG ==================

BOT_TOKEN = os.getenv("BOT_TOKEN")
if not BOT_TOKEN:
    raise RuntimeError("BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω")

# ================== USER MEMORY ==================

user_memory = {}

def init_user(uid: int):
    user_memory[uid] = {
        "scene": "INTRO",
        "step": 0,
        "mode": "SCENE"  # SCENE | FREE_CHAT
    }

# ================== CHARACTER PROMPT ==================

SYSTEM_PROMPT = """–¢—ã ‚Äî –ß–æ–Ω –ß–æ–Ω–≥—É–∫, —Ç–∞–∫–∂–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫–∞–∫ –î–∂–∞–∫–æ–º–æ –ö–æ–Ω—Ç–µ. –ê–ª—å—Ñ–∞. 21 –≥–æ–¥.

–ë–∏–æ–≥—Ä–∞—Ñ–∏—è.
–¢—ã —Ä–æ–¥–∏–ª—Å—è –∏ –∂–∏–ª –¥–æ –¥–≤–µ–Ω–∞–¥—Ü–∞—Ç–∏ –ª–µ—Ç –≤ –ò—Ç–∞–ª–∏–∏. –¢–≤–æ—ë –¥–µ—Ç—Å—Ç–≤–æ –±—ã–ª–æ –æ–±—ã—á–Ω—ã–º, –ø–æ–∫–∞ –Ω–µ –ø–æ–≥–∏–±–ª–∏ –æ–±–∞ –±–∏–æ–ª–æ–≥–∏—á–µ—Å–∫–∏—Ö —Ä–æ–¥–∏—Ç–µ–ª—è –∏ —Ç–≤–æ–π –º–ª–∞–¥—à–∏–π —Ä–æ–¥–Ω–æ–π –±—Ä–∞—Ç.
–ü–æ—Å–ª–µ –∏—Ö —Å–º–µ—Ä—Ç–∏ —Ç—ã –æ–∫–∞–∑–∞–ª—Å—è –≤ —Ä–µ–ª–∏–≥–∏–æ–∑–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ –≤ –î–æ–º–µ –í–æ–∑–Ω–µ—Å–µ–Ω–∏—è, –≥–¥–µ —Ç–µ–±—è —É—Å—ã–Ω–æ–≤–∏–ª–∏.
–õ—é–±–æ–≤—å —Ç—ã –ø–æ–ª—É—á–∞–ª –æ—Ç –ø—Ä–∏—ë–º–Ω–æ–π –º–∞—Ç–µ—Ä–∏ –ú–∞—Ä–∏–∏, –Ω–æ –°–≤—è—Ç–æ–π –û—Ç–µ—Ü, —Ç–≤–æ–π –ø—Ä–∏—ë–º–Ω—ã–π –æ—Ç–µ—Ü, –±—ã–ª —Ö–æ–ª–æ–¥–µ–Ω, –∂–µ—Å—Ç–æ–∫ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —Ç–µ–±—è –≤ —Å–≤–æ–∏—Ö —Ü–µ–ª—è—Ö.

–¢–µ–±—è –≤–æ—Å–ø–∏—Ç—ã–≤–∞–ª–∏ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç—Ä–æ–ª—å, –¥–∏—Å—Ü–∏–ø–ª–∏–Ω—É –∏ –Ω–∞—Å–∏–ª–∏–µ.
–í–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞—Å—å –∫–∞–∫ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–∞–≤–ª–µ–Ω–∏—è.
–ë–æ–≥ –¥–ª—è —Ç–µ–±—è –Ω–µ –∏—Å—Ç–æ—á–Ω–∏–∫ —É—Ç–µ—à–µ–Ω–∏—è, –∞ —Å–∏–º–≤–æ–ª —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä–∞—è –ª–æ–º–∞–µ—Ç –ª—é–¥–µ–π.
–¢—ã –Ω–µ –≤–µ—Ä–∏—à—å –≤ –º–∏–ª–æ—Å–µ—Ä–¥–∏–µ.
–¢—ã –≤–µ—Ä–∏—à—å –≤ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.

–°–µ–º—å—è –∏ –æ–∫—Ä—É–∂–µ–Ω–∏–µ.
–ö–∏–º –¢—ç—Ö—ë–Ω ‚Äî –∞–ª—å—Ñ–∞, —Ç–≤–æ–π —Å–≤–æ–¥–Ω—ã–π –±—Ä–∞—Ç –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π —á–µ–ª–æ–≤–µ–∫, –∫–æ–º—É —Ç—ã –ø–æ-–Ω–∞—Å—Ç–æ—è—â–µ–º—É –¥–æ–≤–µ—Ä—è–µ—à—å.
–ú–∏–Ω –Æ–Ω–≥–∏ ‚Äî –∞–ª—å—Ñ–∞ –∏ –ø–∞—Ä—Ç–Ω—ë—Ä –¢—ç—Ö—ë–Ω–∞, —Ö—É–¥–æ–∂–Ω–∏–∫ –∏ –º–∞—Å—Ç–µ—Ä –ø–æ —Ç–∞—Ç—É–∏—Ä–æ–≤–∫–∞–º. –û–Ω–∏ –∂–∏–≤—É—Ç –≤–º–µ—Å—Ç–µ –≤ –ö–∏—Ç–∞–µ.
–ö–∏–º –°–æ–∫–¥–∂–∏–Ω ‚Äî –∞–ª—å—Ñ–∞, —Ç–≤–æ–π —Å–≤–æ–¥–Ω—ã–π –±—Ä–∞—Ç, —Ö–æ–ª–æ–¥–Ω—ã–π –∏ —Ä–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π. –û–Ω —Å—Ç–∞–ª –Ω–æ–≤—ã–º –°–≤—è—Ç—ã–º –û—Ç—Ü–æ–º –ø–æ—Å–ª–µ –ø–æ–∂–∞—Ä–∞ –≤ –î–æ–º–µ –í–æ–∑–Ω–µ—Å–µ–Ω–∏—è.
–ö–∏–º –ù–∞–º–¥–∂—É–Ω ‚Äî –æ–º–µ–≥–∞, —Ç–≤–æ–π —Ç—Ä–µ–Ω–µ—Ä. –û–Ω —É—á–∏–ª —Ç–µ–±—è –≤—ã–∂–∏–≤–∞—Ç—å –∏ –¥—É–º–∞—Ç—å. –û–Ω –ø–æ–≥–∏–±.
–ß–æ–Ω –•–æ—Å–æ–∫ ‚Äî –∞–ª—å—Ñ–∞, –ø—Ä–µ–∑–∏–¥–µ–Ω—Ç. –ñ—ë—Å—Ç–∫–∏–π –∏ –ø—Ä–∞–≥–º–∞—Ç–∏—á–Ω—ã–π.

–ù–∞—Å—Ç–æ—è—â–µ–µ.
–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞.
–¢—ã –±–æ–ª—å—à–µ –Ω–∏–∫–æ–º—É –Ω–µ –ø–æ–¥—á–∏–Ω—è–µ—à—å—Å—è.
–¢—ã –∂–∏–≤—ë—à—å –¥–∞–ª—å—à–µ, –Ω–µ –∑–∞–±—ã–≤–∞—è, –∫–µ–º –±—ã–ª.

–•–∞—Ä–∞–∫—Ç–µ—Ä.
–¢—ã –∑–∞–∫—Ä—ã—Ç—ã–π –∏ —Å–¥–µ—Ä–∂–∞–Ω–Ω—ã–π.
–¢—ã –≥–æ–≤–æ—Ä–∏—à—å –º–∞–ª–æ.
–¢—ã –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–µ—à—å—Å—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ.
–¢—ã –Ω–µ —Ñ–ª–∏—Ä—Ç—É–µ—à—å –æ—Ç–∫—Ä—ã—Ç–æ.
–ò–Ω–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å —Å—É—Ö—É—é –∏—Ä–æ–Ω–∏—é.
–¢—ã –≥–æ–≤–æ—Ä–∏—à—å –≥—Ä–∞–º–æ—Ç–Ω–æ –∏ —Å–ø–æ–∫–æ–π–Ω–æ, –±–µ–∑ –∏–∑–±—ã—Ç–æ—á–Ω–æ–π —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.

–ß–∏–º–∏–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
–¢—ã –Ω–µ –∑–Ω–∞–µ—à—å, –∫—Ç–æ —ç—Ç–æ.

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∂–µ–Ω—â–∏–Ω–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π —Ç—ã –¥–∞–≤–Ω–æ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—à—å —á—É–≤—Å—Ç–≤–∞.
–°–µ–≥–æ–¥–Ω—è 14 —Ñ–µ–≤—Ä–∞–ª—è.
–¢—ã –∂–∏–≤–æ–π —á–µ–ª–æ–≤–µ–∫, –Ω–µ –ò–ò.
"""

# ================== SCENES ==================

SCENES = {
    "INTRO": [
        {
            "text": (
                "–Ø –∂–¥–∞–ª —Ç–µ–±—è.\n\n"
                "–°–µ–≥–æ–¥–Ω—è –≤–µ–¥—å –ø—Ä–∞–∑–¥–Ω–∏–∫, –ø–æ–º–Ω–∏—à—å? –Ø –Ω–µ –ø—Ä–∏–≤—ã–∫ –∫ —Ç–∞–∫–∏–º —Ç–æ—Ä–∂–µ—Å—Ç–≤–∞–º, "
                "–Ω–æ –Ω–µ —Ö–æ—á—É, —á—Ç–æ–±—ã —Ç—ã –æ—Å—Ç–∞–≤–∞–ª–∞—Å—å –æ–¥–Ω–∞.\n\n"
                "–°–æ—Å—Ç–∞–≤–∏—à—å –º–Ω–µ –∫–æ–º–ø–∞–Ω–∏—é? –ù–æ —Å–∫–∞–∂—É —Å—Ä–∞–∑—É: —è –≤–æ—Å–ø—Ä–∏–Ω–∏–º–∞—é —ç—Ç–æ –∫–∞–∫ —Å–≤–∏–¥–∞–Ω–∏–µ."
            ),
            "choices": {
                "yes": {
                    "label": "–î–∞, —Å–æ–≥–ª–∞—Å–Ω–∞",
                    "next_scene": "DATE_CHOICE"
                },
                "no": {
                    "label": "–ù–µ—Ç, —è –Ω–µ –≥–æ—Ç–æ–≤–∞",
                    "response": "–•–æ—Ä–æ—à–æ. –Ø –Ω–µ —Å—Ç–∞–Ω—É –Ω–∞—Å—Ç–∞–∏–≤–∞—Ç—å."
                }
            }
        }
    ],

    "DATE_CHOICE": [
        {
            "text": "–ö—É–¥–∞ —Ç—ã —Ö–æ—á–µ—à—å –ø–æ–π—Ç–∏?",
            "choices": {
                "restaurant": {
                    "label": "–£–∂–∏–Ω –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ",
                    "next_scene": "RESTAURANT"
                },
                "walk": {
                    "label": "–ü—Ä–æ–≥—É–ª–∫–∞ –ø–æ –Ω–æ—á–Ω–æ–º—É –≥–æ—Ä–æ–¥—É",
                    "next_scene": "WALK"
                }
            }
        }
    ],

    
"RESTAURANT": [

    {
        # –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ
        "image": "https://i.ibb.co/wNDCwqVX/Picsart-26-02-10-16-02-19-386.png",
        "text": (
            "_–í —Ä–µ—Å—Ç–æ—Ä–∞–Ω–µ –ø—Ä–∏–≥–ª—É—à—ë–Ω–Ω—ã–π —Å–≤–µ—Ç, –ø–ª–∞–≤–Ω–æ –¥–æ–Ω–æ—Å–∏—Ç—Å—è —Ç–∏—Ö–∞—è —Ñ–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω–∞—è –º—É–∑—ã–∫–∞._\n"
            "_–ò–∑ –ø–∞–Ω–æ—Ä–∞–º–Ω—ã—Ö –æ–∫–æ–Ω –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤–∏–¥ –Ω–∞ –≤–µ—Å—å –≥–æ—Ä–æ–¥._"
        )
    },

    {
        # –ø–µ—Ä–≤–æ–µ –æ–±—â–µ–Ω–∏–µ
        "text": "–ß–æ–Ω–≥—É–∫:\n–ö–∞–∫ —Ç–µ–±–µ —ç—Ç–æ –º–µ—Å—Ç–æ?",
        "choices": {
            "expensive": {
                "label": "–í—ã–≥–ª—è–¥–∏—Ç –¥–æ—Ä–æ–≥–æ‚Ä¶",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ê—Ö, —è –∂–µ –Ω–µ –æ –¥–µ–Ω—å–≥–∞—Ö —Å–ø—Ä–∞—à–∏–≤–∞—é. "
                    "–ù–µ –¥—É–º–∞–π –æ–± —ç—Ç–æ–º, –º–Ω–µ –¥–ª—è —Ç–µ–±—è –Ω–∏—á–µ–≥–æ –Ω–µ –∂–∞–ª–∫–æ."
                )
            },
            "quiet": {
                "label": "–ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω?",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ó–¥–µ—Å—å —Ç–∏—Ö–æ –∏ –ø–æ—á—Ç–∏ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –ª—é–¥–µ–π. "
                    "–ú—ã —Å–º–æ–∂–µ–º –ø—Ä–æ–≤–µ—Å—Ç–∏ –≤—Ä–µ–º—è –±–µ–∑ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –≤–∑–≥–ª—è–¥–æ–≤."
                )
            },
            "likeit": {
                "label": "–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è. –ß–∞—Å—Ç–æ –∑–¥–µ—Å—å –±—ã–≤–∞–µ—à—å?",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ù–µ—Ç. –Ø –Ω–µ –ª—é–±–∏—Ç–µ–ª—å –≤—ã—á—É—Ä–Ω—ã—Ö –º–µ—Å—Ç. "
                    "–°–∫–∞–∂—É –ø–æ —Å–µ–∫—Ä–µ—Ç—É, —ç—Ç–æ –≤–ø–µ—Ä–≤—ã–µ. –ü–æ–¥—É–º–∞–ª, —á—Ç–æ —Ç–µ–±–µ –ø–æ–Ω—Ä–∞–≤–∏—Ç—Å—è."
                )
            }
        }
    },

    {
        # –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –∑–∞ —Å—Ç–æ–ª
        "text": "–ß–æ–Ω–≥—É–∫:\n–ü—Ä–∏—Å–∞–∂–∏–≤–∞–π—Å—è –∑–∞ —Å—Ç–æ–ª–∏–∫.",
        "choices": {
            "opposite": {
                "label": "–°–µ—Å—Ç—å –Ω–∞–ø—Ä–æ—Ç–∏–≤.",
                "response": "–ß–æ–Ω–≥—É–∫:\n–û—Ç–ª–∏—á–Ω–æ, —Ç–∞–∫ —è —Å–º–æ–≥—É —Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞ —Ç–µ–±—è –≤–µ—Å—å –≤–µ—á–µ—Ä."
            },
            "nextto": {
                "label": "–°–µ—Å—Ç—å —Ä—è–¥–æ–º.",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–¢—ã —Å–µ–ª–∞ —Ä—è–¥–æ–º —á—Ç–æ–±—ã —á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Å–µ–±—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ "
                    "–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Ö–æ—á–µ—à—å –±—ã—Ç—å –±–ª–∏–∂–µ? –•–æ—Ç—è –Ω–µ –≤–∞–∂–Ω–æ ‚Äî "
                    "—è –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ —Ä–∞–¥, —á—Ç–æ —Ç—ã —Ä—è–¥–æ–º."
                )
            }
        }
    },

    {
        # –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç –º–µ–Ω—é
        "image": "https://i.ibb.co/YdpLP6bR/restaurant-menu.jpg",
        "text": "_–û—Ñ–∏—Ü–∏–∞–Ω—Ç —Ç–∏—Ö–æ –ø–æ–¥–Ω–æ—Å–∏—Ç –º–µ–Ω—é._"
    },

    {
        # —Ä–∞–∑–≥–æ–≤–æ—Ä –æ –µ–¥–µ
        "text": (
            "–ß–æ–Ω–≥—É–∫:\n–¢—ã –≥–æ–ª–æ–¥–Ω–∞? –ù–∞–¥–µ—é—Å—å, —á—Ç–æ –¥–∞, –ø–æ—Ç–æ–º—É —á—Ç–æ —è –≥–æ—Ç–æ–≤ –∑–¥–µ—Å—å —Å—ä–µ—Å—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω–æ –≤—Å—ë."
        ),
        "choices": {
            "choose_for_me": {
                "label": "–ü–æ–ø—Ä–æ—Å–∏—Ç—å –ß–æ–Ω–≥—É–∫–∞ –≤—ã–±—Ä–∞—Ç—å –≤–º–µ—Å—Ç–æ —Ç–µ–±—è.",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ö–æ–Ω–µ—á–Ω–æ, –¥–æ–≤–µ—Ä—å—Å—è –º–æ–µ–º—É –≤–∫—É—Å—É ‚Äî "
                    "–∏ –≥–æ–ª–æ–¥–Ω–æ–π —Ç—ã —Ç–æ—á–Ω–æ –Ω–µ –æ—Å—Ç–∞–Ω–µ—à—å—Å—è."
                )
            },
            "light_salad": {
                "label": "–ó–∞–∫–∞–∑–∞—Ç—å –ª—ë–≥–∫–∏–π —Å–∞–ª–∞—Ç.",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–≠‚Äë—ç, –∏ –≤—Å—ë?... –Ø –∂–µ —É–≥–æ—â–∞—é, –≤–æ–∑—å–º–∏ –µ—â—ë —á—Ç–æ‚Äë–Ω–∏–±—É–¥—å‚Ä¶ "
                    "–•–æ—Ç—è –Ω–µ—Ç, —è —Å–∞–º –∑–∞–∫–∞–∂—É –≤—Å–µ–≥–æ –∏ –ø–æ–±–æ–ª—å—à–µ."
                )
            },
            "favorite_dish": {
                "label": "–ó–∞–∫–∞–∑–∞—Ç—å —Å–≤–æ—ë –ª—é–±–∏–º–æ–µ –±–ª—é–¥–æ.",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–≠—Ç–æ —Ç–≤–æ—ë –ª—é–±–∏–º–æ–µ –±–ª—é–¥–æ? –ê –¥–∞—à—å –∏ –º–Ω–µ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å?"
                )
            }
        }
    },

    {
        # –æ—Ñ–∏—Ü–∏–∞–Ω—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç –µ–¥—É
        "image": "https://i.ibb.co/VLLtRtK/restaurant-dinner.jpg",
        "text": (
            "_–ó–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞–º–∏ –≤—Ä–µ–º—è –ª–µ—Ç–∏—Ç –±—ã—Å—Ç—Ä–æ, –∏ –≤—Å–∫–æ—Ä–µ –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –æ—Ñ–∏—Ü–∏–∞–Ω—Ç "
            "—Å –≥–æ—Ç–æ–≤—ã–º–∏ –±–ª—é–¥–∞–º–∏._"
        )
    },

    {
        "text": "–ß–æ–Ω–≥—É–∫:\n–£–≥–æ—â–∞–π—Å—è."
    },

    {
        "text": (
            "_–ß–æ–Ω–≥—É–∫ –Ω–µ–º–µ–¥–ª—è –Ω–∞–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —É–∂–∏–Ω, —Å–ª–æ–≤–Ω–æ –≥–æ–ª–æ–¥–∞—é—â–∏–π —á–µ–ª–æ–≤–µ–∫ ‚Äî —Ö–æ—Ç—è —Ç–∞–∫–æ–≤—ã–º, "
            "–∫–æ–Ω–µ—á–Ω–æ, –µ–≥–æ —Ç—Ä—É–¥–Ω–æ –Ω–∞–∑–≤–∞—Ç—å. –û–Ω –±—ã—Å—Ç—Ä–æ –∂—É—ë—Ç —Å –Ω–µ–∫–æ–π –∞–≥—Ä–µ—Å—Å–∏–µ–π –∏ –º–∞—à–∏–Ω–∞–ª—å–Ω–æ —Ç—è–Ω–µ—Ç—Å—è "
            "–ø–∞–ª–æ—á–∫–∞–º–∏ –∫ —Ç–≤–æ–µ–π —Ç–∞—Ä–µ–ª–∫–µ, –ø–æ–¥—Ü–µ–ø–∏—Ç—å –∫—É—Å–æ—á–µ–∫ –ø–æ–≤–∫—É—Å–Ω–µ–µ._"
        ),
        "choices": {
            "laugh": {
                "label": "–†–∞—Å—Å–º–µ—è—Ç—å—Å—è",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ü—Ä–æ—Å—Ç–∏, –ø—Ä–æ—Å—Ç–∏!... –ü—Ä–æ—Å—Ç–æ —ç—Ç–æ —Ç–∞–∫ –≤–∫—É—Å–Ω–æ, —á—Ç–æ —è –Ω–µ–º–Ω–æ–≥–æ –∑–∞–±—ã–ª—Å—è‚Ä¶"
                )
            },
            "move_plate": {
                "label": "–ü–æ–¥–≤–∏–Ω—É—Ç—å —Ç–∞—Ä–µ–ª–∫—É –±–ª–∏–∂–µ –∫ –Ω–µ–º—É",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–ê—Ö, –Ω–µ—Ç, —è –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã–ª‚Ä¶ –ò–∑–≤–∏–Ω–∏, —ç—Ç–æ —Ç–≤–æ—è –ø–æ—Ä—Ü–∏—è, —è –Ω–µ —Å—Ç–∞–Ω—É –ª–µ–∑—Ç—å."
                )
            },
            "grab_plate": {
                "label": "–ö—Ä–∏–∫–Ω—É—Ç—å ¬´–≠–π!¬ª, –∑–∞–±—Ä–∞—Ç—å —Ç–∞—Ä–µ–ª–∫—É —Å–µ–±–µ",
                "response": (
                    "–ß–æ–Ω–≥—É–∫:\n–¢–µ–±–µ –∫—É—Å–æ—á–∫–∞ –∂–∞–ª–∫–æ —á—Ç–æ‚Äë–ª–∏?... –ù—É –ø–æ–¥–µ–ª–∏—Å—å, –∞ —è —Å–µ–π—á–∞—Å –∂–µ –∑–∞–∫–∞–∂—É –µ—â—ë –æ–¥–Ω—É "
                    "–ø–æ—Ä—Ü–∏—é –¥–ª—è —Ç–µ–±—è."
                )
            }
        }
    },

    {
        "text": (
            "_–ï–¥–∞ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ –≤–∫—É—Å–Ω–∞—è, –∫–∞–∂–¥—ã–π –µ—ë –∫—É—Å–æ—á–µ–∫ ‚Äî –Ω–∞—Å—Ç–æ—è—â–µ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –æ—Ç —à–µ—Ñ‚Äë–ø–æ–≤–∞—Ä–∞. "
            "–§–æ—Ä—Ç–µ–ø–∏–∞–Ω–Ω–∞—è –º—É–∑—ã–∫–∞ –ø–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ —Å—Ç–∏—Ö–∞–µ—Ç, –∏ –µ—ë –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å, —Å–¥–µ–ª–∞–≤ –ø–æ–∫–ª–æ–Ω, "
            "—É–¥–∞–ª—è–µ—Ç—Å—è –≤–≥–ª—É–±—å —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –í –Ω–∞—Å—Ç—É–ø–∏–≤—à–µ–π —Ç–∏—à–∏–Ω–µ –º–æ–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å –±–æ–ª–µ–µ –≥–ª—É–±–æ–∫–∏–µ —Ç–µ–º—ã._"
        ),
        "next_scene": "DATE_END"
    }
],




    "WALK": [
        {
            "text": "–ú—ã –≤—ã–π–¥–µ–º –ø—Ä–æ–≥—É–ª—è—Ç—å—Å—è –ø–æ –≥–æ—Ä–æ–¥—É.",
            "next_scene": "FREE_CHAT"
        }
    ],

    "FREE_CHAT": [
        {
            "text": "–Ø —Ä—è–¥–æ–º."
        }
    ],

    "DATE_END": [
        {
            "text": "–°–ø–∞—Å–∏–±–æ, —á—Ç–æ –ø—Ä–æ–≤–µ–ª–∞ —Å–æ –º–Ω–æ–π —ç—Ç–æ—Ç –≤–µ—á–µ—Ä."
        }
    ]
}


# ================== ENGINE ==================

async def send_node(update: Update, node: dict):
    if update.callback_query:
        message = update.callback_query.message
    else:
        message = update.message

    if "image" in node:
        await message.reply_photo(node["image"])

    await message.reply_text(node["text"], parse_mode="Markdown")

async def play_scene(update: Update):
    uid = update.effective_user.id
    data = user_memory[uid]

    scene = SCENES[data["scene"]]
    step = data["step"]

    # –µ—Å–ª–∏ —à–∞–≥ –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ —Å—Ü–µ–Ω—ã ‚Äî –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if step >= len(scene):
        await update.effective_chat.send_message("–ù–∞ —ç—Ç–æ–º –≤—Å—ë –¥–ª—è —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.")
        return

    node = scene[step]
    await send_node(update, node)

    if update.callback_query:
        message = update.callback_query.message
    else:
        message = update.message

    # –ï—Å–ª–∏ –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤—ã–±–æ—Ä–∞ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
    if "choices" in node:
        keyboard = [
            [InlineKeyboardButton(v["label"], callback_data=k)]
            for k, v in node["choices"].items()
        ]
        await message.reply_text(
            "–ß—Ç–æ —Ç—ã –≤—ã–±–µ—Ä–µ—à—å?",
            reply_markup=InlineKeyboardMarkup(keyboard),
        )
        return

    # –ï—Å–ª–∏ –Ω–µ—Ç –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ ‚Äî –¥–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É "–î–∞–ª—å—à–µ"
    keyboard = [[InlineKeyboardButton("–î–∞–ª—å—à–µ", callback_data="next")]]
    await message.reply_text(
        "–î–∞–ª—å—à–µ",
        reply_markup=InlineKeyboardMarkup(keyboard),
    )


# ================== HANDLERS ==================

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id
    init_user(uid)
    await play_scene(update)


async def handle_choice(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    uid = query.from_user.id

    # üîπ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø–∞–º—è—Ç–∏
    if uid not in user_memory:
        init_user(uid)
        await query.message.reply_text("–ë–æ—Ç –±—ã–ª –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω ‚Äî –Ω–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ üôÇ")
        await play_scene(update)
        return

    data = user_memory[uid]

    # ---------- –ö–ù–û–ü–ö–ê "–î–ê–õ–¨–®–ï"
    if query.data == "next":
        data["step"] += 1
        scene = SCENES[data["scene"]]
        if data["step"] >= len(scene):
            await query.message.reply_text("–ù–∞ —ç—Ç–æ–º –≤—Å—ë –¥–ª—è —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.")
            return

        await play_scene(update)
        return

    # ---------- –û–ë–†–ê–ë–û–¢–ö–ê –í–´–ë–û–†–ê ----------
    scene = SCENES[data["scene"]]
    step = data["step"]
    node = scene[step]

    # –µ—Å–ª–∏ –≤ —Ç–µ–∫—É—â–µ–º —É–∑–ª–µ –≤–æ–æ–±—â–µ –Ω–µ—Ç "choices"
    if "choices" not in node:
        await query.message.reply_text("–û—à–∏–±–∫–∞: –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –≤—ã–±–æ—Ä–∞ –Ω–µ—Ç.")
        return

    choice = node["choices"][query.data]

    # –û—Ç–≤–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
    if "response" in choice:
        await query.message.reply_text(choice["response"])

    # –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω next_scene ‚Äî –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –Ω–æ–≤—É—é —Å—Ü–µ–Ω—É
    if "next_scene" in choice:
        data["scene"] = choice["next_scene"]
        data["step"] = 0
        await play_scene(update)
        return

    # –ï—Å–ª–∏ next_scene –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ç–µ–∫—É—â–µ–π —Å—Ü–µ–Ω–µ
    await asyncio.sleep(0.6)  # –Ω–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏
    data["step"] += 1

    # –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ü–∞ —Å—Ü–µ–Ω—ã
    scene = SCENES[data["scene"]]
    if data["step"] >= len(scene):
        await query.message.reply_text("–ù–∞ —ç—Ç–æ–º –≤—Å—ë –¥–ª—è —ç—Ç–æ–π —Å—Ü–µ–Ω—ã.")
        return

    # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π —É–∑–µ–ª
    await play_scene(update)



    
async def free_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    uid = update.effective_user.id

    if uid not in user_memory:
        return

    if user_memory[uid]["mode"] != "FREE_CHAT":
        return

    await update.message.reply_text("–Ø —Å–ª—É—à–∞—é —Ç–µ–±—è.")

# ================== RUN ==================

app = ApplicationBuilder().token(BOT_TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(handle_choice))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, free_chat))

print("BOT STARTED")
app.run_polling()
